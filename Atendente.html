<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interface do Atendente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            padding: 10px;
        }

        .container { 
            max-width: 800px;
            padding: 0 10px;
        }

        .queue-display { 
            margin-top: 20px;
        }

        .queue-item {
            display: inline-block;
            margin: 5px;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 0.9rem;
            word-wrap: break-word;
            white-space: normal;
        }

        .queue-item.prioritaria {
            background-color: #ffc107; 
            font-weight: bold;
            border-color: #e0a800;
        }

        .queue-item.normal {
            background-color: #f8f9fa;
        }

        #senhaAtual {
            font-size: 2.5rem;
            font-weight: bold;
            color: #dc3545;
        }

        .btn-group {
            flex-wrap: wrap;
        }

        .btn-group .btn {
            flex: 1 1 auto;
            min-width: 150px;
            margin: 3px;
        }

        /* Media Queries para Mobile */
        @media (max-width: 768px) {
            .container {
                padding: 0 5px;
                max-width: 100%;
            }

            body {
                padding: 5px;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn-group .btn {
                width: 100%;
                margin: 5px 0;
                font-size: 0.85rem;
                padding: 0.5rem;
            }

            #senhaAtual {
                font-size: 1.8rem;
            }

            .queue-item {
                font-size: 0.8rem;
                padding: 5px 8px;
                margin: 3px;
            }

            .row {
                margin: 0 -5px;
            }

            .row > [class*='col-'] {
                padding: 0 5px;
            }

            h1 {
                font-size: 1.5rem;
            }

            h4 {
                font-size: 1rem;
            }

            .card {
                margin: 10px 0 !important;
            }
        }

        @media (max-width: 480px) {
            .container {
                max-width: 100%;
                padding: 0;
            }

            body {
                padding: 0;
            }

            h1 {
                font-size: 1.2rem;
                margin-bottom: 1rem !important;
            }

            #senhaAtual {
                font-size: 1.5rem;
            }

            .queue-item {
                font-size: 0.75rem;
                padding: 4px 6px;
            }

            .btn-group .btn {
                font-size: 0.75rem;
                padding: 0.4rem;
            }

            .alert {
                font-size: 0.9rem;
                padding: 0.5rem;
            }

            .card-body {
                padding: 0.75rem !important;
            }

            p {
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Central de Controle do Atendente</h1>

        <div class="alert alert-primary text-center" role="alert">
            Clique nos botões abaixo para abrir as telas em uma nova aba:
        </div>
        <div class="btn-group w-100 mb-4" role="group">
            <a href="PainelMonitor.html" target="_blank" class="btn btn-dark btn-lg">Abrir Painel Monitor</a>
            <a href="Agendamento.html" target="_blank" class="btn btn-secondary btn-lg">Abrir Tela de Agendamento</a>
            <a href="Feedback.html" target="_blank" class="btn btn-secondary btn-lg">Abrir Tela de Feedback</a>
        </div>
        
        <hr>

        <div class="row mb-4">
            <div class="col-12 col-md-6 mb-3">
                <label for="guicheSelect" class="form-label">Selecione Seu Guichê:</label>
                <select id="guicheSelect" class="form-select">
                    <option value="G-01" selected>Guichê 01 (G-01)</option>
                    <option value="G-02">Guichê 02 (G-02)</option>
                    <option value="G-03">Guichê 03 (G-03)</option>
                    <option value="G-04">Guichê 04 (G-04)</option>
                </select>
            </div>
            
            <div class="col-12 col-md-6 mb-3">
                <label for="temaSelect" class="form-label">Selecione o Tema do Painel:</label>
                <select id="temaSelect" class="form-select" onchange="mudarTema()">
                    <option value="azul">Tema Azul (Padrão)</option>
                    <option value="verde">Tema Verde</option>
                    <option value="roxo">Tema Roxo</option>
                </select>
            </div>
        </div>

        <hr>

        <div class="d-grid gap-2 mb-4">
            <button id="chamarBtn" class="btn btn-warning btn-lg" onclick="chamarProximaSenha()">
                Chamar Próxima Senha (Prioriza 'P')
            </button>
        </div>

        <h4 class="text-center mb-3">Gerar Senhas (Funcionalidade 2)</h4>
        <div class="row mb-4 g-2">
             <div class="col-12 col-sm-6">
                <button class="btn btn-success btn-lg w-100" onclick="gerarNovaSenha('P')">
                    Gerar Prioritária (P)
                </button>
            </div>
            <div class="col-12 col-sm-6">
                <button class="btn btn-info btn-lg w-100" onclick="gerarNovaSenha('N')">
                    Gerar Normal (N)
                </button>
            </div>
        </div>
        
        <div class="card p-3 text-center">
            <h5>Senha em Atendimento: <span id="senhaAtual">---</span></h5>
            <p class="mt-2 text-info">
                Tempo Estimado de Espera: <span id="tempoEstimadoAtendente">0 min</span>
            </p>
        </div>

        <div class="queue-display">
            <h4 class="text-secondary">Fila de Espera (Funcionalidade 3):</h4>
            <div id="queueList">A fila está vazia.</div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Definições de controle
        const MAX_CALLS_HISTORY = 8;
        let proximaSenhaNormal = 1;
        let proximaSenhaPrioritaria = 1;
        const TEMPO_MEDIO_POR_ATENDIMENTO = 3; 

        // Funcionalidade 19: Lógica de Mudança de Tema
        function mudarTema() {
            const tema = document.getElementById('temaSelect').value;
            localStorage.setItem('painelTema', tema);
        }
        
        function init() {
            // Carrega tema salvo
            const storedTema = localStorage.getItem('painelTema') || 'azul';
            document.getElementById('temaSelect').value = storedTema;
            
            // ✅ CORREÇÃO 1: Carrega a última senha chamada para referência do atendente
            const currentTicket = localStorage.getItem('currentTicket');
            if (currentTicket) {
                document.getElementById('senhaAtual').textContent = currentTicket;
            }
            
            // ✅ CORREÇÃO 2: Carrega o último tempo de espera calculado para referência do atendente
            const estimatedWaitTime = localStorage.getItem('estimatedWaitTime') || '0 min';
            document.getElementById('tempoEstimadoAtendente').textContent = estimatedWaitTime;


            // Funcionalidade 10: Inicialização e Carga de Dados de Fila (Lógica de contagem mantida)
            const storedQueue = localStorage.getItem('ticketQueue');
            if (storedQueue) {
                const queueArray = JSON.parse(storedQueue);
                
                let maxN = 0;
                let maxP = 0;
                
                queueArray.forEach(senha => {
                    const tipo = senha.substring(0, 1);
                    const num = parseInt(senha.substring(2));
                    if (tipo === 'N' && num > maxN) maxN = num;
                    if (tipo === 'P' && num > maxP) maxP = num;
                });

                proximaSenhaNormal = maxN + 1;
                proximaSenhaPrioritaria = maxP + 1;
            }
            updateQueueDisplay();
        }

        // Funcionalidade 2 & 20: Gera uma nova senha
        function gerarNovaSenha(tipo) {
            let novaSenha;
            if (tipo === 'P') {
                novaSenha = `P-${String(proximaSenhaPrioritaria).padStart(2, '0')}`;
                proximaSenhaPrioritaria++;
            } else {
                novaSenha = `N-${String(proximaSenhaNormal).padStart(2, '0')}`;
                proximaSenhaNormal++;
            }

            let queue = JSON.parse(localStorage.getItem('ticketQueue') || '[]');
            queue.push(novaSenha); 
            localStorage.setItem('ticketQueue', JSON.stringify(queue));
            
            updateQueueDisplay();
        }

        // Funcionalidade 3, 6, 7 & 20: Chama a próxima senha com Lógica de Prioridade
        function chamarProximaSenha() {
            let queue = JSON.parse(localStorage.getItem('ticketQueue') || '[]');
            
            if (queue.length === 0) {
                alert("A fila está vazia. Gere novas senhas.");
                return;
            }
            
            let nextTicketIndex = queue.findIndex(senha => senha.startsWith('P-'));
            let nextTicket;
            
            if (nextTicketIndex !== -1) {
                nextTicket = queue.splice(nextTicketIndex, 1)[0];
            } else {
                nextTicket = queue.shift();
            }

            localStorage.setItem('ticketQueue', JSON.stringify(queue));
            
            const currentWindow = document.getElementById('guicheSelect').value;
            const now = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

            // Esses comandos já estavam corretos e garantem a comunicação com o PainelMonitor.html
            localStorage.setItem('currentTicket', nextTicket);
            localStorage.setItem('currentWindow', currentWindow); 
            
            let previousCalls = JSON.parse(localStorage.getItem('previousCalls') || '[]');
            const newCall = { ticket: nextTicket, window: currentWindow, time: now }; 
            previousCalls.unshift(newCall); 
            previousCalls = previousCalls.slice(0, MAX_CALLS_HISTORY); 
            localStorage.setItem('previousCalls', JSON.stringify(previousCalls)); 

            document.getElementById('senhaAtual').textContent = nextTicket;
            falarSenha(nextTicket, currentWindow); 
            
            updateQueueDisplay();
        }

        // Funcionalidade 5: Calcula e salva o tempo de espera
        function calcularEAtualizarTempoEspera(queueLength) {
            const tempoTotalMinutos = queueLength * TEMPO_MEDIO_POR_ATENDIMENTO;
            const displayElement = document.getElementById('tempoEstimadoAtendente');
            
            let tempoFormatado = '0 min';
            
            if (tempoTotalMinutos > 60) {
                const horas = Math.floor(tempoTotalMinutos / 60);
                const minutos = tempoTotalMinutos % 60;
                tempoFormatado = `${horas}h ${minutos}min`;
            } else if (tempoTotalMinutos > 0) {
                tempoFormatado = `${tempoTotalMinutos} min`;
            }

            // Garante que o PainelMonitor leia o tempo de espera
            localStorage.setItem('estimatedWaitTime', tempoFormatado);
            displayElement.textContent = tempoFormatado;
        }


        // Funcionalidade 3 & 20: Atualiza a exibição da fila
        function updateQueueDisplay() {
            const queue = JSON.parse(localStorage.getItem('ticketQueue') || '[]');
            const listDiv = document.getElementById('queueList');
            listDiv.innerHTML = '';

            // O cálculo e salvamento do tempo de espera é feito aqui antes de atualizar o display
            calcularEAtualizarTempoEspera(queue.length);
            
            if (queue.length === 0) {
                listDiv.textContent = 'A fila está vazia.';
                return;
            }

            queue.forEach(senha => {
                const tipo = senha.substring(0, 1);
                const span = document.createElement('span');
                span.className = `queue-item ${tipo === 'P' ? 'prioritaria' : 'normal'}`;
                span.textContent = senha;
                listDiv.appendChild(span);
            });
        }

        // Funcionalidade 7: Lógica de Fala (Notificação Sonora)
        function falarSenha(senha, guiche) {
            if (!('speechSynthesis' in window)) return;

            const utterance = new SpeechSynthesisUtterance();
            utterance.lang = 'pt-BR';
            utterance.text = `Senha ${senha}, dirija-se ao guichê ${guiche}. Repetindo: Senha ${senha}, guichê ${guiche}.`;
            
            window.speechSynthesis.speak(utterance);
        }

        init();
    </script>
</body>
</html>